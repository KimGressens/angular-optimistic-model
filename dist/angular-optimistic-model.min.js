angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b,c){return angular.extend({},a.modelOptions,b,c||{})}function d(a,b){var c=new a;if(b&&b.toJSON&&(b=b.toJSON()),b=angular.copy(b),c.fromJSON)c.fromJSON(b);else for(var d in b)"$"!==d[0]&&(c[d]=b[d]);return c}function e(a){if(angular.isArray(a)){for(var b=[],c=0;c<a.length;c++)b[c]=e(a[c]);return b}var f=d(a.constructor,a);return f[x]=a,f}function f(a,c){i(A,a,c),b.$broadcast("modelCached",a,A[a])}function g(a,b,e,g){var h=c(a,b);if(!g&&angular.isArray(e)&&(g=e,e=h.ns),!g&&angular.isObject(e)&&(g=e,e=h.ns+"/"+g[h.idField]),g)if(angular.isArray(g)){for(var i=[],j=0;j<g.length;j++){var k=d(a,g[j]);h.populateChildren&&f(e+"/"+k[h.idField],k),i.push(k)}f(e,i)}else f(e,d(a,g))}function h(a,b){if(angular.isArray(a)){for(var c=0;c<a.length;c++)b[c]=a[c];b.length=a.length}else for(var d in a)"_"!==d[0]&&(b[d]=a[d])}function i(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];h(c,d)}}function j(a,b,c,d){d&&a[b]&&a[b][d]&&a[b][d]!==c[d]&&delete a[b],i(a,b,c)}function k(a,b,c,d){c=!!c,a.toScope=function(f,g){if(A[b]){var h=A[b];j(f,g,c?e(h):h,d)}return a.then(function(a){j(f,g,a,d)}),a.then(function(){return f[g]})}}function l(b){var c=a.defer();return c.resolve(b),c.promise}function m(a,c,d){b.$broadcast("model"+a+"Started",c,d),d.finally(function(){b.$broadcast("model"+a+"Ended",c,d)})}function n(a,b,d){var f=c(a,b,d),h=f.ns,i=!!f.cloned,j=null;return j=f.useCached&&A[h]?l(i?e(A[h]):A[h]):f.backend("GET",h).then(function(c){return g(a,b,h,c),i?e(A[h]):A[h]}),k(j,h,i),j}function o(a,b,d){var f=c(a,b),h=f.ns+"/"+d,i=!!f.cloned,j=null;return j=f.useCached&&f.useCachedChildren&&A[h]?l(i?e(A[h]):A[h]):f.backend("GET",h).then(function(c){return g(a,b,h,c),i?e(A[h]):A[h]}),k(j,h,i,f.idField),j}function p(a,b,e,g){var i=c(a,b),j=e;if(g){j={};for(var l=0;l<g.length;l++)j[g[l]]=e[g[l]]}var m=i.ns+"/"+e[i.idField],n=i.backend("PUT",m,j).then(function(b){var c=d(a,b);return f(m,c),h(c,e),delete e[y],A[m]});return k(n,m),n}function q(a,b,d){var e=c(a,b),f="object"==typeof d?d[e.idField]:d,g=e.ns+"/"+f,h=e.backend("DELETE",g).then(function(){delete A[g];var a=A[e.ns];if(a){for(var b=-1,c=0;c<a.length;c++)a[c][e.idField]===f&&(b=c);b>-1&&a.splice(b,1)}});return m("Delete",d,h),h}function r(a,b,e){var g=c(a,b);return g.backend("POST",g.ns,e).then(function(b){var c=d(a,b),i=g.ns+"/"+c[g.idField];f(i,c);var j=A[i];h(j,e),e[x]=j,delete e[y];var k=A[g.ns];if(k){for(var l=!1,m=0;m<k.length;m++)k[m][g.idField]===c[g.idField]&&(l=!0);l||k.push(j)}return j})}function s(){var a=this,b=a.constructor.modelOptions,c=null;return c=a[b.idField]?a.update():a.create(),m("Save",a,c),c}function t(){var a=this.constructor.modelOptions,b={};if(this[a.idField]){if(!this[x])throw new Error("Only works on clones!");b=this[x],this[y]&&(b=this[y])}else this[y]&&(b=this[y]);return!angular.equals(this,b)}function u(){var a=this.constructor.modelOptions;if(this[a.idField]&&!this[x])throw new Error("Only works on clones!");this[y]=e(this)}function v(a,b,c){return function(){var d=angular.extend({},a.modelOptions,c);return b.apply(null,[a,d].concat(Array.prototype.slice.call(arguments,0)))}}function w(a){return function(){var b=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return a.apply(null,b)}}var x="$$cloneParent",y="$$snapshot",z={idField:"id",populateChildren:!0,useCached:!1,useCachedChildren:!0},A={},B={defaults:function(a){z=angular.extend(z,a)},extend:function(a,b){a.getAll=v(a,n),a.get=v(a,o),a.getCached=v(a,o,{useCached:!0}),a.getClone=v(a,o,{cloned:!0}),a.update=v(a,p),a.delete=v(a,q),a.create=v(a,r),a.cache=v(a,g),a.modelOptions=angular.extend({},z,b);var c=a.prototype;c.update=w(p),c.delete=w(q),c.create=w(r),c.save=s,c.hasChanges=t,c.snapshot=u},clear:function(){A={}},getCache:function(a){return A[a]},get:o,getAll:n,update:p,"delete":q,create:r};return B}]);