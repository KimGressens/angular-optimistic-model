angular.module("rt.optimisticcache",[]).factory("optimisticCache",function(){function a(a){return e[a]}function b(a,d,f){if(f||(f={}),f.mapper)if(angular.isArray(d))for(var g=0;g<d.length;g++)d[g]=f.mapper(d[g]);else d=f.mapper(d);if(c(e,a,d),angular.isArray(d)&&f.populateChildren)for(var h=0;h<d.length;h++){var i=d[h];b(a+"/"+i[f.idField],i)}}function c(a,b,d){if(d)if(a[b]){var e=a[b];if(angular.isArray(e)){for(var f=0;f<d.length;f++)c(e,f,angular.copy(d[f]));e.length=d.length}else for(var g in d)e[g]=d[g]}else a[b]=d}function d(d,e,f){return f||(f={}),(null===f.idField||void 0===f.idField)&&(f.idField="id"),(null===f.populateChildren||void 0===f.populateChildren)&&(f.populateChildren=!0),d.then(function(a){b(e,a,f)}),d.toScope=function(b,f){return c(b,f,a(e)),d.then(function(){c(b,f,a(e))}),d.then(function(){return b[f]})},d}var e={};return d.clear=function(){e={}},d}),angular.module("rt.optimisticmodel",[]).factory("Model",function(){function a(a,b){var c=new a;if(c.fromJSON)c.fromJSON(b);else for(var d in b)c[d]=b[d];return c}function b(a,b){c(l,a,b)}function c(a,b,c){if(!a[b])return void(a[b]=c);var d=a[b];if(angular.isArray(c)){for(var e=0;e<c.length;e++)d[e]=c[e];d.length=c.length}else for(var f in c)d[f]=c[f]}function d(a,b,d){c(a,b,d)}function e(a,b){a.toScope=function(c,e){return l[b]&&d(c,e,l[b]),a.then(function(a){d(c,e,a)}),a}}function f(){var c=this,d=c.modelOptions,f=d.ns,g=d.backend("GET",f).then(function(e){for(var g=[],h=0;h<e.length;h++){var i=a(c,e[h]);d.populateChildren&&b(f+"/"+i[d.idField],i),g.push(i)}return b(f,g),l[f]});return e(g,f),g}function g(c){var d=this,f=d.modelOptions,g=f.ns+"/"+c,h=f.backend("GET",g).then(function(c){var e=a(d,c);return b(g,e),l[g]});return e(h,g),h}function h(c,d){var f=this;c||(c=f,f=c.constructor);var g=c;if(d){g={};for(var h=0;h<d.length;h++)g[d[h]]=c[d[h]]}var i=f.modelOptions,j=i.ns+"/"+c[i.idField],k=i.backend("PUT",j,g).then(function(c){var d=a(f,c);return b(j,d),l[j]});return e(k,j),k}function i(a){var b=this;a||(a=b,b=a.constructor);var c=b.modelOptions,d="object"==typeof a?a[c.idField]:a,e=c.ns+"/"+d;return c.backend("DELETE",e).then(function(){delete l[e];var a=l[c.ns];if(a){for(var b=-1,f=0;f<a.length;f++)a[f][c.idField]===d&&(b=f);b>-1&&a.splice(b,1)}})}function j(c){var d=this;c||(c=d,d=c.constructor);var e=d.modelOptions;return e.backend("POST",e.ns,c).then(function(c){var f=a(d,c),g=e.ns+"/"+f[e.idField];b(g,f);var h=l[g],i=l[e.ns];if(i){for(var j=!1,k=0;k<i.length;k++)i[k][e.idField]===f[e.idField]&&(j=!0);j||i.push(h)}return h})}var k={idField:"id",populateChildren:!0},l={},m={defaults:function(a){k=angular.extend(k,a)},extend:function(a,b){a.getAll=f,a.get=g,a.update=h,a.delete=i,a.create=j,a.modelOptions=angular.extend({},k,b);var c=a.prototype;c.update=h,c.delete=i,c.create=j},clear:function(){l={}},cache:b};return m});