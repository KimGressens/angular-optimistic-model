angular.module("rt.optimisticmodel",[]).factory("Model",function(){function a(a,b){var c=new a;if(c.fromJSON)c.fromJSON(b);else for(var d in b)c[d]=b[d];return c}function b(a,b){c(m,a,b)}function c(a,b,c){if(!a[b])return void(a[b]=c);var d=a[b];if(angular.isArray(c)){for(var e=0;e<c.length;e++)d[e]=c[e];d.length=c.length}else for(var f in c)d[f]=c[f]}function d(a,b,d){c(a,b,d)}function e(a,b){a.toScope=function(c,e){return m[b]&&d(c,e,m[b]),a.then(function(a){d(c,e,a)}),a}}function f(){var c=this,d=c.modelOptions,f=d.ns,g=d.backend("GET",f).then(function(e){for(var g=[],h=0;h<e.length;h++){var i=a(c,e[h]);d.populateChildren&&b(f+"/"+i[d.idField],i),g.push(i)}return b(f,g),m[f]});return e(g,f),g}function g(c){var d=this,f=d.modelOptions,g=f.ns+"/"+c,h=f.backend("GET",g).then(function(c){var e=a(d,c);return b(g,e),m[g]});return e(h,g),h}function h(c,d){var f=this;c||(c=f,f=c.constructor);var g=c;if(d){g={};for(var h=0;h<d.length;h++)g[d[h]]=c[d[h]]}var i=f.modelOptions,j=i.ns+"/"+c[i.idField],k=i.backend("PUT",j,g).then(function(c){var d=a(f,c);return b(j,d),m[j]});return e(k,j),k}function i(a){var b=this;a||(a=b,b=a.constructor);var c=b.modelOptions,d="object"==typeof a?a[c.idField]:a,e=c.ns+"/"+d;return c.backend("DELETE",e).then(function(){delete m[e];var a=m[c.ns];if(a){for(var b=-1,f=0;f<a.length;f++)a[f][c.idField]===d&&(b=f);b>-1&&a.splice(b,1)}})}function j(c){var d=this;c||(c=d,d=c.constructor);var e=d.modelOptions;return e.backend("POST",e.ns,c).then(function(c){var f=a(d,c),g=e.ns+"/"+f[e.idField];b(g,f);var h=m[g],i=m[e.ns];if(i){for(var j=!1,k=0;k<i.length;k++)i[k][e.idField]===f[e.idField]&&(j=!0);j||i.push(h)}return h})}function k(){var a=this.constructor.modelOptions;return this[a.idField]?this.update():this.create()}var l={idField:"id",populateChildren:!0},m={},n={defaults:function(a){l=angular.extend(l,a)},extend:function(a,b){a.getAll=f,a.get=g,a.update=h,a.delete=i,a.create=j,a.modelOptions=angular.extend({},l,b);var c=a.prototype;c.update=h,c.delete=i,c.create=j,c.save=k},clear:function(){m={}},cache:b};return n});