angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b){var c=new a;if(b&&b.toJSON&&(b=b.toJSON()),c.fromJSON)c.fromJSON(b);else for(var d in b)c[d]=b[d];return c}function d(a){return c(a.constructor,a)}function e(a,b){g(s,a,b)}function f(a,b){var d=this.modelOptions;if(angular.isArray(b)){for(var f=[],g=0;g<b.length;g++){var h=c(this,b[g]);d.populateChildren&&e(a+"/"+h[d.idField],h),f.push(h)}e(a,f)}else e(a,c(this,b))}function g(a,b,c){if(!a[b])return void(a[b]=c);var d=a[b];if(angular.isArray(c)){for(var e=0;e<c.length;e++)d[e]=c[e];d.length=c.length}else for(var f in c)d[f]=c[f]}function h(a,b,c){g(a,b,c)}function i(a,b,c){c=!!c,a.toScope=function(e,f){if(s[b]){var g=s[b];h(e,f,c?d(g):g)}return a.then(function(a){h(e,f,a)}),a.then(function(){return e[f]})}}function j(b){var c=a.defer();return c.resolve(b),c.promise}function k(){var a=this,b=a.modelOptions,c=b.ns,d=null;return d=b.useCached&&s[c]?j(s[c]):b.backend("GET",c).then(function(b){return f.call(a,c,b),s[c]}),i(d,c),d}function l(a,b){var c=this;b=!!b;var e=c.modelOptions,g=e.ns+"/"+a,h=null;return h=e.useCached&&s[g]?j(s[g]):e.backend("GET",g).then(function(a){return f.call(c,g,a),b?d(s[g]):s[g]}),i(h,g,b),h}function m(a){return this.get(a,!0)}function n(a,b){var d=this;a||(a=d,d=a.constructor);var f=a;if(b){f={};for(var g=0;g<b.length;g++)f[b[g]]=a[b[g]]}var h=d.modelOptions,j=h.ns+"/"+a[h.idField],k=h.backend("PUT",j,f).then(function(a){var b=c(d,a);return e(j,b),s[j]});return i(k,j),k}function o(a){var b=this;a||(a=b,b=a.constructor);var c=b.modelOptions,d="object"==typeof a?a[c.idField]:a,e=c.ns+"/"+d;return c.backend("DELETE",e).then(function(){delete s[e];var a=s[c.ns];if(a){for(var b=-1,f=0;f<a.length;f++)a[f][c.idField]===d&&(b=f);b>-1&&a.splice(b,1)}})}function p(a){var b=this;a||(a=b,b=a.constructor);var d=b.modelOptions;return d.backend("POST",d.ns,a).then(function(a){var f=c(b,a),g=d.ns+"/"+f[d.idField];e(g,f);var h=s[g],i=s[d.ns];if(i){for(var j=!1,k=0;k<i.length;k++)i[k][d.idField]===f[d.idField]&&(j=!0);j||i.push(h)}return h})}function q(){var a=this,c=a.constructor.modelOptions;b.$broadcast("modelSaveStarted",a);var d=null;return d=a[c.idField]?a.update():a.create(),d.finally(function(){b.$broadcast("modelSaveEnded",a)}),d}var r={idField:"id",populateChildren:!0,useCached:!1},s={},t={defaults:function(a){r=angular.extend(r,a)},extend:function(a,b){a.getAll=k,a.get=l,a.getClone=m,a.update=n,a.delete=o,a.create=p,a.cache=f,a.modelOptions=angular.extend({},r,b);var c=a.prototype;c.update=n,c.delete=o,c.create=p,c.save=q},clear:function(){s={}},getCache:function(a){return s[a]}};return t}]);