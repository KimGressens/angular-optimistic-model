angular.module("rt.optimisticmodel",[]).factory("Model",["$q",function(a){function b(a,b){var c=new a;if(b&&b.toJSON&&(b=b.toJSON()),c.fromJSON)c.fromJSON(b);else for(var d in b)c[d]=b[d];return c}function c(a){return b(a.constructor,a)}function d(a,b){f(r,a,b)}function e(a,c){var e=this.modelOptions;if(angular.isArray(c)){for(var f=[],g=0;g<c.length;g++){var h=b(this,c[g]);e.populateChildren&&d(a+"/"+h[e.idField],h),f.push(h)}d(a,f)}else d(a,b(this,c))}function f(a,b,c){if(!a[b])return void(a[b]=c);var d=a[b];if(angular.isArray(c)){for(var e=0;e<c.length;e++)d[e]=c[e];d.length=c.length}else for(var f in c)d[f]=c[f]}function g(a,b,c){f(a,b,c)}function h(a,b,d){d=!!d,a.toScope=function(e,f){if(r[b]){var h=r[b];g(e,f,d?c(h):h)}return a.then(function(a){g(e,f,a)}),a.then(function(){return e[f]})}}function i(b){var c=a.defer();return c.resolve(b),c.promise}function j(){var a=this,b=a.modelOptions,c=b.ns,d=null;return d=b.useCached&&r[c]?i(r[c]):b.backend("GET",c).then(function(b){return e.call(a,c,b),r[c]}),h(d,c),d}function k(a,b){var d=this;b=!!b;var f=d.modelOptions,g=f.ns+"/"+a,j=null;return j=f.useCached&&r[g]?i(r[g]):f.backend("GET",g).then(function(a){return e.call(d,g,a),b?c(r[g]):r[g]}),h(j,g,b),j}function l(a){return this.get(a,!0)}function m(a,c){var e=this;a||(a=e,e=a.constructor);var f=a;if(c){f={};for(var g=0;g<c.length;g++)f[c[g]]=a[c[g]]}var i=e.modelOptions,j=i.ns+"/"+a[i.idField],k=i.backend("PUT",j,f).then(function(a){var c=b(e,a);return d(j,c),r[j]});return h(k,j),k}function n(a){var b=this;a||(a=b,b=a.constructor);var c=b.modelOptions,d="object"==typeof a?a[c.idField]:a,e=c.ns+"/"+d;return c.backend("DELETE",e).then(function(){delete r[e];var a=r[c.ns];if(a){for(var b=-1,f=0;f<a.length;f++)a[f][c.idField]===d&&(b=f);b>-1&&a.splice(b,1)}})}function o(a){var c=this;a||(a=c,c=a.constructor);var e=c.modelOptions;return e.backend("POST",e.ns,a).then(function(a){var f=b(c,a),g=e.ns+"/"+f[e.idField];d(g,f);var h=r[g],i=r[e.ns];if(i){for(var j=!1,k=0;k<i.length;k++)i[k][e.idField]===f[e.idField]&&(j=!0);j||i.push(h)}return h})}function p(){var a=this.constructor.modelOptions;return this[a.idField]?this.update():this.create()}var q={idField:"id",populateChildren:!0,useCached:!1},r={},s={defaults:function(a){q=angular.extend(q,a)},extend:function(a,b){a.getAll=j,a.get=k,a.getClone=l,a.update=m,a.delete=n,a.create=o,a.cache=e,a.modelOptions=angular.extend({},q,b);var c=a.prototype;c.update=m,c.delete=n,c.create=o,c.save=p},clear:function(){r={}}};return s}]);