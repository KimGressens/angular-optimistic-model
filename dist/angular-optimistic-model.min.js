angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b){return angular.extend({},a.modelOptions,b)}function d(a,b){var c=new a;if(b&&b.toJSON&&(b=b.toJSON()),b=angular.copy(b),c.fromJSON)c.fromJSON(b);else for(var d in b)c[d]=b[d];return c}function e(a){return d(a.constructor,a)}function f(a,c){h(u,a,c),b.$broadcast("modelCached",a,u[a])}function g(a,b,e,g){var h=c(a,b);if(angular.isArray(g)){for(var i=[],j=0;j<g.length;j++){var k=d(a,g[j]);h.populateChildren&&f(e+"/"+k[h.idField],k),i.push(k)}f(e,i)}else f(e,d(a,g))}function h(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];if(angular.isArray(c)){for(var e=0;e<c.length;e++)d[e]=c[e];d.length=c.length}else for(var f in c)d[f]=c[f]}}function i(a,b,c){h(a,b,c)}function j(a,b,c){c=!!c,a.toScope=function(d,f){if(u[b]){var g=u[b];i(d,f,c?e(g):g)}return a.then(function(a){i(d,f,a)}),a.then(function(){return d[f]})}}function k(b){var c=a.defer();return c.resolve(b),c.promise}function l(a,b){var d=c(a,b),e=d.ns,f=null;return f=d.useCached&&u[e]?k(u[e]):d.backend("GET",e).then(function(c){return g(a,b,e,c),u[e]}),j(f,e),f}function m(a,b,d){var f=c(a,b),h=f.ns+"/"+d,i=!!f.cloned,l=null;return l=f.useCached&&u[h]?k(i?e(u[h]):u[h]):f.backend("GET",h).then(function(c){return g(a,b,h,c),i?e(u[h]):u[h]}),j(l,h,i),l}function n(a,b,e,g){var h=c(a,b),i=e;if(g){i={};for(var k=0;k<g.length;k++)i[g[k]]=e[g[k]]}var l=h.ns+"/"+e[h.idField],m=h.backend("PUT",l,i).then(function(b){var c=d(a,b);return f(l,c),u[l]});return j(m,l),m}function o(a,b,d){var e=c(a,b),f="object"==typeof d?d[e.idField]:d,g=e.ns+"/"+f;return e.backend("DELETE",g).then(function(){delete u[g];var a=u[e.ns];if(a){for(var b=-1,c=0;c<a.length;c++)a[c][e.idField]===f&&(b=c);b>-1&&a.splice(b,1)}})}function p(a,b,e){var g=c(a,b);return g.backend("POST",g.ns,e).then(function(b){var c=d(a,b),e=g.ns+"/"+c[g.idField];f(e,c);var h=u[e],i=u[g.ns];if(i){for(var j=!1,k=0;k<i.length;k++)i[k][g.idField]===c[g.idField]&&(j=!0);j||i.push(h)}return h})}function q(){var a=this,c=a.constructor.modelOptions,d=null;return d=a[c.idField]?a.update():a.create(),b.$broadcast("modelSaveStarted",a,d),d.finally(function(){b.$broadcast("modelSaveEnded",a,d)}),d}function r(a,b,c){return function(){var d=angular.extend({},a.modelOptions,c);return b.apply(null,[a,d].concat(Array.prototype.slice.call(arguments,0)))}}function s(a){return function(){var b=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return a.apply(null,b)}}var t={idField:"id",populateChildren:!0,useCached:!1},u={},v={defaults:function(a){t=angular.extend(t,a)},extend:function(a,b){a.getAll=r(a,l),a.get=r(a,m),a.getCached=r(a,m,{useCached:!0}),a.getClone=r(a,m,{cloned:!0}),a.update=r(a,n),a.delete=r(a,o),a.create=r(a,p),a.cache=r(a,g),a.modelOptions=angular.extend({},t,b);var c=a.prototype;c.update=s(n),c.delete=s(o),c.create=s(p),c.save=q},clear:function(){u={}},getCache:function(a){return u[a]},get:m,getAll:l,update:n,"delete":o,create:p};return v}]);