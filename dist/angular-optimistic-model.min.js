angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b){return angular.extend({},a.modelOptions,b)}function d(a,b){var c=new a;if(b&&b.toJSON&&(b=b.toJSON()),b=angular.copy(b),c.fromJSON)c.fromJSON(b);else for(var d in b)c[d]=b[d];return c}function e(a){return d(a.constructor,a)}function f(a,c){h(v,a,c),b.$broadcast("modelCached",a,v[a])}function g(a,b,e,g){var h=c(a,b);if(!g&&angular.isArray(e)&&(g=e,e=h.ns),!g&&angular.isObject(e)&&(g=e,e=h.ns+"/"+g[h.idField]),g)if(angular.isArray(g)){for(var i=[],j=0;j<g.length;j++){var k=d(a,g[j]);h.populateChildren&&f(e+"/"+k[h.idField],k),i.push(k)}f(e,i)}else f(e,d(a,g))}function h(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];if(angular.isArray(c)){for(var e=0;e<c.length;e++)d[e]=c[e];d.length=c.length}else for(var f in c)d[f]=c[f]}}function i(a,b,c){h(a,b,c)}function j(a,b,c){c=!!c,a.toScope=function(d,f){if(v[b]){var g=v[b];i(d,f,c?e(g):g)}return a.then(function(a){i(d,f,a)}),a.then(function(){return d[f]})}}function k(b){var c=a.defer();return c.resolve(b),c.promise}function l(a,c,d){b.$broadcast("model"+a+"Started",c,d),d.finally(function(){b.$broadcast("model"+a+"Ended",c,d)})}function m(a,b){var d=c(a,b),e=d.ns,f=null;return f=d.useCached&&v[e]?k(v[e]):d.backend("GET",e).then(function(c){return g(a,b,e,c),v[e]}),j(f,e),f}function n(a,b,d){var f=c(a,b),h=f.ns+"/"+d,i=!!f.cloned,l=null;return l=f.useCached&&f.useCachedChildren&&v[h]?k(i?e(v[h]):v[h]):f.backend("GET",h).then(function(c){return g(a,b,h,c),i?e(v[h]):v[h]}),j(l,h,i),l}function o(a,b,e,g){var h=c(a,b),i=e;if(g){i={};for(var k=0;k<g.length;k++)i[g[k]]=e[g[k]]}var l=h.ns+"/"+e[h.idField],m=h.backend("PUT",l,i).then(function(b){var c=d(a,b);return f(l,c),v[l]});return j(m,l),m}function p(a,b,d){var e=c(a,b),f="object"==typeof d?d[e.idField]:d,g=e.ns+"/"+f,h=e.backend("DELETE",g).then(function(){delete v[g];var a=v[e.ns];if(a){for(var b=-1,c=0;c<a.length;c++)a[c][e.idField]===f&&(b=c);b>-1&&a.splice(b,1)}});return l("Delete",d,h),h}function q(a,b,e){var g=c(a,b);return g.backend("POST",g.ns,e).then(function(b){var c=d(a,b),e=g.ns+"/"+c[g.idField];f(e,c);var h=v[e],i=v[g.ns];if(i){for(var j=!1,k=0;k<i.length;k++)i[k][g.idField]===c[g.idField]&&(j=!0);j||i.push(h)}return h})}function r(){var a=this,b=a.constructor.modelOptions,c=null;return c=a[b.idField]?a.update():a.create(),l("Save",a,c),c}function s(a,b,c){return function(){var d=angular.extend({},a.modelOptions,c);return b.apply(null,[a,d].concat(Array.prototype.slice.call(arguments,0)))}}function t(a){return function(){var b=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return a.apply(null,b)}}var u={idField:"id",populateChildren:!0,useCached:!1,useCachedChildren:!0},v={},w={defaults:function(a){u=angular.extend(u,a)},extend:function(a,b){a.getAll=s(a,m),a.get=s(a,n),a.getCached=s(a,n,{useCached:!0}),a.getClone=s(a,n,{cloned:!0}),a.update=s(a,o),a.delete=s(a,p),a.create=s(a,q),a.cache=s(a,g),a.modelOptions=angular.extend({},u,b);var c=a.prototype;c.update=t(o),c.delete=t(p),c.create=t(q),c.save=r},clear:function(){v={}},getCache:function(a){return v[a]},get:n,getAll:m,update:o,"delete":p,create:q};return w}]);