angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b){var c=new a;if(b&&b.toJSON&&(b=b.toJSON()),c.fromJSON)c.fromJSON(b);else for(var d in b)c[d]=b[d];return c}function d(a){return c(a.constructor,a)}function e(a,c){g(u,a,c),b.$broadcast("modelCached",a,u[a])}function f(a,b){var d=this.modelOptions;if(angular.isArray(b)){for(var f=[],g=0;g<b.length;g++){var h=c(this,b[g]);d.populateChildren&&e(a+"/"+h[d.idField],h),f.push(h)}e(a,f)}else e(a,c(this,b))}function g(a,b,c){if(!a[b])return void(a[b]=c);var d=a[b];if(angular.isArray(c)){for(var e=0;e<c.length;e++)d[e]=c[e];d.length=c.length}else for(var f in c)d[f]=c[f]}function h(a,b,c){g(a,b,c)}function i(a,b,c){c=!!c,a.toScope=function(e,f){if(u[b]){var g=u[b];h(e,f,c?d(g):g)}return a.then(function(a){h(e,f,a)}),a.then(function(){return e[f]})}}function j(b){var c=a.defer();return c.resolve(b),c.promise}function k(a,b){var c=b.ns,d=null;return d=b.useCached&&u[c]?j(u[c]):b.backend("GET",c).then(function(b){return f.call(a,c,b),u[c]}),i(d,c),d}function l(a,b){var c=this;b=!!b;var e=c.modelOptions,g=e.ns+"/"+a,h=null;return h=e.useCached&&u[g]?j(u[g]):e.backend("GET",g).then(function(a){return f.call(c,g,a),b?d(u[g]):u[g]}),i(h,g,b),h}function m(a){return this.get(a,!0)}function n(a,b,d,f){var g=d;if(f){g={};for(var h=0;h<f.length;h++)g[f[h]]=d[f[h]]}var j=b.ns+"/"+d[b.idField],k=b.backend("PUT",j,g).then(function(b){var d=c(a,b);return e(j,d),u[j]});return i(k,j),k}function o(a,b,c){var d="object"==typeof c?c[b.idField]:c,e=b.ns+"/"+d;return b.backend("DELETE",e).then(function(){delete u[e];var a=u[b.ns];if(a){for(var c=-1,f=0;f<a.length;f++)a[f][b.idField]===d&&(c=f);c>-1&&a.splice(c,1)}})}function p(a,b,d){return b.backend("POST",b.ns,d).then(function(d){var f=c(a,d),g=b.ns+"/"+f[b.idField];e(g,f);var h=u[g],i=u[b.ns];if(i){for(var j=!1,k=0;k<i.length;k++)i[k][b.idField]===f[b.idField]&&(j=!0);j||i.push(h)}return h})}function q(){var a=this,c=a.constructor.modelOptions,d=null;return d=a[c.idField]?a.update():a.create(),b.$broadcast("modelSaveStarted",a,d),d.finally(function(){b.$broadcast("modelSaveEnded",a,d)}),d}function r(a,b){return function(){return b.apply(null,[a,a.modelOptions].concat(Array.prototype.slice.call(arguments,0)))}}function s(a){return function(){return a(this.constructor,this.constructor.modelOptions,this)}}var t={idField:"id",populateChildren:!0,useCached:!1},u={},v={defaults:function(a){t=angular.extend(t,a)},extend:function(a,b){a.getAll=r(a,k),a.get=l,a.getClone=m,a.update=r(a,n),a.delete=r(a,o),a.create=r(a,p),a.cache=f,a.modelOptions=angular.extend({},t,b);var c=a.prototype;c.update=s(n),c.delete=s(o),c.create=s(p),c.save=q},clear:function(){u={}},getCache:function(a){return u[a]},getAll:k,update:n,"delete":o,create:p};return v}]);