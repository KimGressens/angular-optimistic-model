angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b,c){return angular.extend({},a.modelOptions,b,c||{})}function d(a,b){var c=new a;if(b&&b.toJSON&&(b=b.toJSON()),b=angular.copy(b),c.fromJSON)c.fromJSON(b);else for(var d in b)c[d]=b[d];return c}function e(a){if(angular.isArray(a)){for(var b=[],c=0;c<a.length;c++)b[c]=e(a[c]);return b}var f=d(a.constructor,a);return f[v]=a,f}function f(a,c){h(x,a,c),b.$broadcast("modelCached",a,x[a])}function g(a,b,e,g){var h=c(a,b);if(!g&&angular.isArray(e)&&(g=e,e=h.ns),!g&&angular.isObject(e)&&(g=e,e=h.ns+"/"+g[h.idField]),g)if(angular.isArray(g)){for(var i=[],j=0;j<g.length;j++){var k=d(a,g[j]);h.populateChildren&&f(e+"/"+k[h.idField],k),i.push(k)}f(e,i)}else f(e,d(a,g))}function h(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];if(angular.isArray(c)){for(var e=0;e<c.length;e++)d[e]=c[e];d.length=c.length}else for(var f in c)"_"!==f[0]&&(d[f]=c[f])}}function i(a,b,c,d){d&&a[b]&&a[b][d]&&a[b][d]!==c[d]&&delete a[b],h(a,b,c)}function j(a,b,c,d){c=!!c,a.toScope=function(f,g){if(x[b]){var h=x[b];i(f,g,c?e(h):h,d)}return a.then(function(a){i(f,g,a,d)}),a.then(function(){return f[g]})}}function k(b){var c=a.defer();return c.resolve(b),c.promise}function l(a,c,d){b.$broadcast("model"+a+"Started",c,d),d.finally(function(){b.$broadcast("model"+a+"Ended",c,d)})}function m(a,b,d){var f=c(a,b,d),h=f.ns,i=!!f.cloned,l=null;return l=f.useCached&&x[h]?k(i?e(x[h]):x[h]):f.backend("GET",h).then(function(c){return g(a,b,h,c),i?e(x[h]):x[h]}),j(l,h,i),l}function n(a,b,d){var f=c(a,b),h=f.ns+"/"+d,i=!!f.cloned,l=null;return l=f.useCached&&f.useCachedChildren&&x[h]?k(i?e(x[h]):x[h]):f.backend("GET",h).then(function(c){return g(a,b,h,c),i?e(x[h]):x[h]}),j(l,h,i,f.idField),l}function o(a,b,e,g){var h=c(a,b),i=e;if(g){i={};for(var k=0;k<g.length;k++)i[g[k]]=e[g[k]]}var l=h.ns+"/"+e[h.idField],m=h.backend("PUT",l,i).then(function(b){var c=d(a,b);return f(l,c),x[l]});return j(m,l),m}function p(a,b,d){var e=c(a,b),f="object"==typeof d?d[e.idField]:d,g=e.ns+"/"+f,h=e.backend("DELETE",g).then(function(){delete x[g];var a=x[e.ns];if(a){for(var b=-1,c=0;c<a.length;c++)a[c][e.idField]===f&&(b=c);b>-1&&a.splice(b,1)}});return l("Delete",d,h),h}function q(a,b,e){var g=c(a,b);return g.backend("POST",g.ns,e).then(function(b){var c=d(a,b),e=g.ns+"/"+c[g.idField];f(e,c);var h=x[e],i=x[g.ns];if(i){for(var j=!1,k=0;k<i.length;k++)i[k][g.idField]===c[g.idField]&&(j=!0);j||i.push(h)}return h})}function r(){var a=this,b=a.constructor.modelOptions,c=null;return c=a[b.idField]?a.update():a.create(),l("Save",a,c),c}function s(){if(!this[v])throw new Error("Only works on clones!");return!angular.equals(this,this[v])}function t(a,b,c){return function(){var d=angular.extend({},a.modelOptions,c);return b.apply(null,[a,d].concat(Array.prototype.slice.call(arguments,0)))}}function u(a){return function(){var b=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return a.apply(null,b)}}var v="$$cloneParent",w={idField:"id",populateChildren:!0,useCached:!1,useCachedChildren:!0},x={},y={defaults:function(a){w=angular.extend(w,a)},extend:function(a,b){a.getAll=t(a,m),a.get=t(a,n),a.getCached=t(a,n,{useCached:!0}),a.getClone=t(a,n,{cloned:!0}),a.update=t(a,o),a.delete=t(a,p),a.create=t(a,q),a.cache=t(a,g),a.modelOptions=angular.extend({},w,b);var c=a.prototype;c.update=u(o),c.delete=u(p),c.create=u(q),c.save=r,c.hasChanges=s},clear:function(){x={}},getCache:function(a){return x[a]},get:n,getAll:m,update:o,"delete":p,create:q};return y}]);