angular.module("rt.optimisticmodel",[]).factory("Model",function(){function a(a,b){var c=new a;if(b&&b.toJSON&&(b=b.toJSON()),c.fromJSON)c.fromJSON(b);else for(var d in b)c[d]=b[d];return c}function b(b){return a(b.constructor,b)}function c(a,b){d(o,a,b)}function d(a,b,c){if(!a[b])return void(a[b]=c);var d=a[b];if(angular.isArray(c)){for(var e=0;e<c.length;e++)d[e]=c[e];d.length=c.length}else for(var f in c)d[f]=c[f]}function e(a,b,c){d(a,b,c)}function f(a,c,d){d=!!d,a.toScope=function(f,g){if(o[c]){var h=o[c];e(f,g,d?b(h):h)}return a.then(function(a){e(f,g,a)}),a.then(function(){return f[g]})}}function g(){var b=this,d=b.modelOptions,e=d.ns,g=d.backend("GET",e).then(function(f){for(var g=[],h=0;h<f.length;h++){var i=a(b,f[h]);d.populateChildren&&c(e+"/"+i[d.idField],i),g.push(i)}return c(e,g),o[e]});return f(g,e),g}function h(d,e){var g=this;e=!!e;var h=g.modelOptions,i=h.ns+"/"+d,j=h.backend("GET",i).then(function(d){var f=a(g,d);return c(i,f),e?b(f):o[i]});return f(j,i,e),j}function i(a){return this.get(a,!0)}function j(b,d){var e=this;b||(b=e,e=b.constructor);var g=b;if(d){g={};for(var h=0;h<d.length;h++)g[d[h]]=b[d[h]]}var i=e.modelOptions,j=i.ns+"/"+b[i.idField],k=i.backend("PUT",j,g).then(function(b){var d=a(e,b);return c(j,d),o[j]});return f(k,j),k}function k(a){var b=this;a||(a=b,b=a.constructor);var c=b.modelOptions,d="object"==typeof a?a[c.idField]:a,e=c.ns+"/"+d;return c.backend("DELETE",e).then(function(){delete o[e];var a=o[c.ns];if(a){for(var b=-1,f=0;f<a.length;f++)a[f][c.idField]===d&&(b=f);b>-1&&a.splice(b,1)}})}function l(b){var d=this;b||(b=d,d=b.constructor);var e=d.modelOptions;return e.backend("POST",e.ns,b).then(function(b){var f=a(d,b),g=e.ns+"/"+f[e.idField];c(g,f);var h=o[g],i=o[e.ns];if(i){for(var j=!1,k=0;k<i.length;k++)i[k][e.idField]===f[e.idField]&&(j=!0);j||i.push(h)}return h})}function m(){var a=this.constructor.modelOptions;return this[a.idField]?this.update():this.create()}var n={idField:"id",populateChildren:!0},o={},p={defaults:function(a){n=angular.extend(n,a)},extend:function(a,b){a.getAll=g,a.get=h,a.getClone=i,a.update=j,a.delete=k,a.create=l,a.modelOptions=angular.extend({},n,b);var c=a.prototype;c.update=j,c.delete=k,c.create=l,c.save=m},clear:function(){o={}},cache:c};return p});