angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b){var c=new a;if(b&&b.toJSON&&(b=b.toJSON()),c.fromJSON)c.fromJSON(b);else for(var d in b)c[d]=b[d];return c}function d(a){return c(a.constructor,a)}function e(a,c){g(t,a,c),b.$broadcast("modelCached",a,t[a])}function f(a,b,d,f){if(angular.isArray(f)){for(var g=[],h=0;h<f.length;h++){var i=c(a,f[h]);b.populateChildren&&e(d+"/"+i[b.idField],i),g.push(i)}e(d,g)}else e(d,c(a,f))}function g(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];if(angular.isArray(c)){for(var e=0;e<c.length;e++)d[e]=c[e];d.length=c.length}else for(var f in c)d[f]=c[f]}}function h(a,b,c){g(a,b,c)}function i(a,b,c){c=!!c,a.toScope=function(e,f){if(t[b]){var g=t[b];h(e,f,c?d(g):g)}return a.then(function(a){h(e,f,a)}),a.then(function(){return e[f]})}}function j(b){var c=a.defer();return c.resolve(b),c.promise}function k(a,b){var c=b.ns,d=null;return d=b.useCached&&t[c]?j(t[c]):b.backend("GET",c).then(function(d){return f(a,b,c,d),t[c]}),i(d,c),d}function l(a,b,c){var e=b.ns+"/"+c,g=!!b.cloned,h=null;return h=b.useCached&&t[e]?j(t[e]):b.backend("GET",e).then(function(c){return f(a,b,e,c),g?d(t[e]):t[e]}),i(h,e,g),h}function m(a,b,d,f){var g=d;if(f){g={};for(var h=0;h<f.length;h++)g[f[h]]=d[f[h]]}var j=b.ns+"/"+d[b.idField],k=b.backend("PUT",j,g).then(function(b){var d=c(a,b);return e(j,d),t[j]});return i(k,j),k}function n(a,b,c){var d="object"==typeof c?c[b.idField]:c,e=b.ns+"/"+d;return b.backend("DELETE",e).then(function(){delete t[e];var a=t[b.ns];if(a){for(var c=-1,f=0;f<a.length;f++)a[f][b.idField]===d&&(c=f);c>-1&&a.splice(c,1)}})}function o(a,b,d){return b.backend("POST",b.ns,d).then(function(d){var f=c(a,d),g=b.ns+"/"+f[b.idField];e(g,f);var h=t[g],i=t[b.ns];if(i){for(var j=!1,k=0;k<i.length;k++)i[k][b.idField]===f[b.idField]&&(j=!0);j||i.push(h)}return h})}function p(){var a=this,c=a.constructor[u],d=null;return d=a[c.idField]?a.update():a.create(),b.$broadcast("modelSaveStarted",a,d),d.finally(function(){b.$broadcast("modelSaveEnded",a,d)}),d}function q(a,b,c){return function(){var d=angular.extend({},a[u],c);return b.apply(null,[a,d].concat(Array.prototype.slice.call(arguments,0)))}}function r(a){return function(){return a(this.constructor,this.constructor[u],this)}}var s={idField:"id",populateChildren:!0,useCached:!1},t={},u="modelOptions",v={defaults:function(a){s=angular.extend(s,a)},extend:function(a,b){a.getAll=q(a,k),a.get=q(a,l),a.getCached=q(a,l,{useCached:!0}),a.getClone=q(a,l,{cloned:!0}),a.update=q(a,m),a.delete=q(a,n),a.create=q(a,o),a.cache=q(a,f),a[u]=angular.extend({},s,b);var c=a.prototype;c.update=r(m),c.delete=r(n),c.create=r(o),c.save=p},clear:function(){t={}},getCache:function(a){return t[a]},get:l,getAll:k,update:m,"delete":n,create:o};return v}]);