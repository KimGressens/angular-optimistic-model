angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b,c){return angular.extend({},a.modelOptions,b,c||{})}function d(a,b){var c=new a;if(b&&b.toJSON&&(b=b.toJSON()),b=angular.copy(b),c.fromJSON)c.fromJSON(b);else for(var d in b)"$"!==d[0]&&(c[d]=b[d]);return c}function e(a){if(angular.isArray(a)){for(var b=[],c=0;c<a.length;c++)b[c]=e(a[c]);return b}var f=d(a.constructor,a);return f[y]=a,f}function f(a,c){i(B,a,c),b.$broadcast("modelCached",a,B[a])}function g(a,b,e,g){var h=c(a,b);if(!g&&angular.isArray(e)&&(g=e,e=h.ns),!g&&angular.isObject(e)&&(g=e,e=h.ns+"/"+g[h.idField]),g)if(angular.isArray(g)){for(var i=[],j=0;j<g.length;j++){var k=d(a,g[j]);h.populateChildren&&f(e+"/"+k[h.idField],k),i.push(k)}f(e,i)}else f(e,d(a,g))}function h(a,b){if(angular.isArray(a)){for(var c=0;c<a.length;c++)b[c]=a[c];b.length=a.length}else for(var d in a)"_"!==d[0]&&(b[d]=a[d])}function i(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];h(c,d)}}function j(a,b,c,d){d&&a[b]&&a[b][d]&&a[b][d]!==c[d]&&delete a[b],i(a,b,c)}function k(a,b,c,d){c=!!c,a.toScope=function(f,g){if(B[b]){var h=B[b];j(f,g,c?e(h):h,d)}return a.then(function(a){j(f,g,a,d)}),a.then(function(){return f[g]})}}function l(b){var c=a.defer();return c.resolve(b),c.promise}function m(a,c,d){b.$broadcast("model"+a+"Started",c,d),d.finally(function(){b.$broadcast("model"+a+"Ended",c,d)})}function n(a,b,d){var f=c(a,b,d),h=f.ns,i=!!f.cloned,j=null;return j=f.useCached&&B[h]?l(i?e(B[h]):B[h]):f.backend("GET",h).then(function(c){return g(a,b,h,c),i?e(B[h]):B[h]}),k(j,h,i),j}function o(a,b,d){var f=c(a,b),h=f.ns+"/"+d,i=!!f.cloned,j=null;return j=f.useCached&&f.useCachedChildren&&B[h]?l(i?e(B[h]):B[h]):f.backend("GET",h).then(function(c){return g(a,b,h,c),i?e(B[h]):B[h]}),k(j,h,i,f.idField),j}function p(a,b,d){var e=c(a,b);if(!e.useCached)throw new Error("Can only use getSync on models that have useCached: true");var f=e.ns+"/"+d;return B[f]}function q(a,b,e,g){var i=c(a,b),j=e;if(g){j={};for(var l=0;l<g.length;l++)j[g[l]]=e[g[l]]}var m=i.ns+"/"+e[i.idField],n=i.backend("PUT",m,j).then(function(b){var c=d(a,b);return f(m,c),h(c,e),delete e[z],B[m]});return k(n,m),n}function r(a,b,d){var e=c(a,b),f="object"==typeof d?d[e.idField]:d,g=e.ns+"/"+f,h=e.backend("DELETE",g).then(function(){delete B[g];var a=B[e.ns];if(a){for(var b=-1,c=0;c<a.length;c++)a[c][e.idField]===f&&(b=c);b>-1&&a.splice(b,1)}});return m("Delete",d,h),h}function s(a,b,e){var g=c(a,b);return g.backend("POST",g.ns,e).then(function(b){var c=d(a,b),i=g.ns+"/"+c[g.idField];f(i,c);var j=B[i];h(j,e),e[y]=j,delete e[z];var k=B[g.ns];if(k){for(var l=!1,m=0;m<k.length;m++)k[m][g.idField]===c[g.idField]&&(l=!0);l||k.push(j)}return j})}function t(){var a=this,b=a.constructor.modelOptions,c=null;return c=a[b.idField]?a.update():a.create(),m("Save",a,c),c}function u(){var a=this.constructor.modelOptions,b={};if(this[a.idField]){if(!this[y])throw new Error("Only works on clones!");b=this[y],this[z]&&(b=this[z])}else this[z]&&(b=this[z]);return!angular.equals(this,b)}function v(){var a=this.constructor.modelOptions;if(this[a.idField]&&!this[y])throw new Error("Only works on clones!");this[z]=e(this)}function w(a,b,c){return function(){var d=angular.extend({},a.modelOptions,c);return b.apply(null,[a,d].concat(Array.prototype.slice.call(arguments,0)))}}function x(a){return function(){var b=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return a.apply(null,b)}}var y="$$cloneParent",z="$$snapshot",A={idField:"id",populateChildren:!0,useCached:!1,useCachedChildren:!0},B={},C={defaults:function(a){A=angular.extend(A,a)},extend:function(a,b){a.getAll=w(a,n),a.get=w(a,o),a.getCached=w(a,o,{useCached:!0}),a.getClone=w(a,o,{cloned:!0}),a.getSync=w(a,p),a.update=w(a,q),a.delete=w(a,r),a.create=w(a,s),a.cache=w(a,g),a.modelOptions=angular.extend({},A,b);var c=a.prototype;c.update=x(q),c.delete=x(r),c.create=x(s),c.save=t,c.hasChanges=u,c.snapshot=v},clear:function(){B={}},getCache:function(a){return B[a]},get:o,getAll:n,update:q,"delete":r,create:s,mkToScope:k};return C}]);